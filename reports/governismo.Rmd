---
title: "Governismo"
output:
    html_document: 
        # self_contained: no
        theme: sandstone
---

To do: vis e planilha que detalha votações sem orientação de ninguém.

Tirar votações consensuais; quantificá-las 

Lidar com orientação Liberado

Se orientação = Não e o voto é obstrução, isso é concordância?


```{r warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(here)
library(lubridate)

library(reactable)
library(hrbrthemes)
theme_set(theme_ipsum_rc())

source(here::here("code/lib.R"))

knitr::opts_chunk$set(tidy = FALSE, 
                      echo = FALSE,
                      warning = FALSE)
set.seed(1014)
options(digits = 2, scipen = 999)

# Cores: https://colors.muz.li/palette/f9b4ab/fdebd3/264e70/679186/bbd4ce
```


```{r}
votacoes = read_votacoes()

votos2020 = read_csv(
  here::here("data/votos.csv.gz"),
  col_types = cols(.default = col_character(), dataHoraVoto = col_datetime(format = ""))
) 

orientacoes2020 = read_csv(
  here::here("data/orientacoes.csv"),
  col_types = cols(.default = col_character(), prioridade_orientacao = col_integer())
) 

orientacao_gov = orientacoes2020 %>% 
  filter(siglaBancada %in% c("Governo"), orientacao != "Liberado")
```

## Votações e orientação

```{r}
votacoes %>% 
  filter(nominal) %>% 
  mutate(semana = floor_date(data, "month")) %>% 
  count(semana, tem_orientacao_gov) %>% 
  ggplot(aes(x = semana, y = n, fill = tem_orientacao_gov)) + 
  geom_col(position = position_stack())
```

Quem orienta: 

```{r}
orientacoes2020 %>% 
  count(siglaBancada, sort = T)
```

## Votos e orientação

```{r}
votos_orientados = votos2020 %>%
  inner_join(orientacao_gov, by = c("idVotacao", "uriVotacao"))
```

```{r}
governismos = votos_orientados %>% 
  group_by(idVotacao) %>% 
  summarise(
    data = min(dataHoraVoto),
    obedeceram = sum(voto == orientacao), 
            votos = n(),
            desobedeceram = sum(voto != orientacao), 
            governismo = obedeceram / (obedeceram + desobedeceram), 
            tipo_orientacao = first(siglaBancada)) %>% 
  ungroup() %>% 
  filter(governismo <= .9 & governismo >= .1)

library(RcppRoll)

JANELA = 20

media_movel = governismos %>% 
  arrange(data) %>% 
  mutate(media = roll_mean(governismo, JANELA, na.rm = TRUE, align="right", fill = NA)) %>% 
  # group_by(data_round) %>% 
  # summarise(media = mean(media, na.rm = T)) %>% 
  filter(!is.na(media))
```


## Governismo 


```{r}
ggplot() + 
  geom_rect(data = governismos, 
            xmin = as.POSIXct(as.Date("2020-02-26")), 
            xmax = as.POSIXct(max(governismos$data)), 
            ymin = -Inf, ymax = Inf, 
            fill = "#ededed") + 
  geom_point(data = governismos, 
             aes(x = data, y = governismo),
             color = "salmon",
             alpha = .5) + 
  # geom_line(data = media_movel, aes(x = data_round, y = media), color = "black") +
  geom_step(data = media_movel, aes(x = data, y = media), color = "black") +
  scale_y_percent() +
  labs(
    title = "Aderência à orientação do governo por votação", 
    subtitle = str_glue(
      "Pontos são votações, excluindo consensuais. Linha é a média das últimas {JANELA}."
    ),
    color = "Orientação", 
    x = "Data", 
    y = "Aderência"
  ) + 
  NULL
```


